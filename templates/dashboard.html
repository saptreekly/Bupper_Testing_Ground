<!DOCTYPE html>
<html>
<head>
    <title>QAOA Route Optimizer Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .dashboard-card {
            margin-bottom: 20px;
            height: 100%;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .metric-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .backend-selector {
            margin-bottom: 20px;
        }
        .optimization-status {
            margin-top: 10px;
            font-weight: bold;
        }
        #map-container {
            height: 500px;
            width: 100%;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        #metrics-history {
            height: 300px;
        }
        #circuit-depth {
            height: 250px;
        }
        #backend-comparison {
            height: 300px;
        }
        #progress-log {
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
        }
        .progress-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .progress-entry .timestamp {
            color: #666;
            margin-right: 10px;
        }
        .progress-entry.error {
            color: #dc3545;
            background-color: #fff8f8;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="optimization-status" id="optimization-status">
                Optimizing routes...<br>
                <small class="text-muted">This may take a few minutes</small>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <h1>QAOA Route Optimizer Dashboard</h1>

        <div class="row">
            <!-- Control Panel -->
            <div class="col-md-3">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Optimization Controls</h5>
                        <form id="optimization-form">
                            <div class="mb-3">
                                <label for="n_cities" class="form-label">Number of Cities</label>
                                <input type="number" class="form-control" id="n_cities" name="n_cities" value="4" min="3" max="6">
                            </div>
                            <div class="mb-3">
                                <label for="backend" class="form-label">Backend</label>
                                <select class="form-control" id="backend" name="backend">
                                    <option value="qiskit">Qiskit</option>
                                    <option value="pennylane">PennyLane</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" name="location" 
                                       value="San Francisco, California, USA">
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="hybrid" name="hybrid">
                                <label class="form-check-label" for="hybrid">Use Hybrid Optimization</label>
                            </div>
                            <button type="submit" class="btn btn-primary">Run Optimization</button>
                        </form>
                    </div>
                </div>

                <!-- Progress Updates -->
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Optimization Progress</h5>
                        <div id="progress-log"></div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Key Metrics</h5>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="metric-label">Total Time</div>
                                <div class="metric-value" id="total-time">-</div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="metric-label">Solution Length</div>
                                <div class="metric-value" id="solution-length">-</div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="metric-label">Quantum Advantage</div>
                                <div class="metric-value" id="quantum-advantage">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Dashboard Area -->
            <div class="col-md-9">
                <!-- Route Map -->
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Route Visualization</h5>
                        <div id="map-container">
                            <iframe id="map-frame" style="width:100%;height:100%;border:none;"></iframe>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">Optimization Progress</h5>
                                <div id="metrics-history"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">Circuit Complexity</h5>
                                <div id="circuit-depth"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backend Comparison -->
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Backend Performance Comparison</h5>
                        <div id="backend-comparison"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        let currentTaskId = null;

        // Add progress log entry
        function addProgressEntry(message, timestamp, isError = false) {
            const progressLog = document.getElementById('progress-log');
            const entry = document.createElement('div');
            entry.className = `progress-entry${isError ? ' error' : ''}`;
            entry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="message">${message}</span>
            `;
            progressLog.appendChild(entry);
            progressLog.scrollTop = progressLog.scrollHeight;
        }

        // Initialize Plotly charts with empty data
        function initializeCharts() {
            // Optimization Progress Chart
            Plotly.newPlot('metrics-history', [{
                y: [],
                type: 'scatter',
                name: 'Cost Function'
            }], {
                title: 'Optimization Progress',
                xaxis: { title: 'Iteration' },
                yaxis: { title: 'Cost' }
            });

            // Circuit Depth Chart
            Plotly.newPlot('circuit-depth', [{
                x: ['Initial', 'Optimized'],
                y: [0, 0],
                type: 'bar',
                name: 'Circuit Depth'
            }], {
                title: 'Circuit Complexity',
                yaxis: { title: 'Depth' }
            });

            // Backend Comparison Chart
            Plotly.newPlot('backend-comparison', [{
                x: ['Qiskit', 'PennyLane'],
                y: [0, 0],
                type: 'bar',
                name: 'Execution Time (s)'
            }], {
                title: 'Backend Performance',
                yaxis: { title: 'Time (s)' }
            });
        }

        // Update dashboard with new optimization results
        function updateDashboard(data) {
            // Hide loading overlay
            document.getElementById('loading-overlay').style.display = 'none';

            // Update metrics
            document.getElementById('total-time').textContent = `${data.metrics.total_time.toFixed(2)}s`;
            document.getElementById('solution-length').textContent = `${data.metrics.solution_length.toFixed(2)}m`;
            document.getElementById('quantum-advantage').textContent = 
                `${(data.metrics.quantum_classical_gap * 100).toFixed(1)}%`;

            // Update map
            const mapFrame = document.getElementById('map-frame');
            const cacheBuster = new Date().getTime();
            mapFrame.src = `${data.map_path}?_=${cacheBuster}`;

            // Update optimization progress chart
            Plotly.update('metrics-history', {
                y: [data.metrics.cost_history]
            });

            // Update circuit depth chart
            Plotly.update('circuit-depth', {
                y: [[data.metrics.initial_depth, data.metrics.optimized_depth]]
            });

            // Update backend comparison
            if (data.metrics.backend_times) {
                Plotly.update('backend-comparison', {
                    y: [Object.values(data.metrics.backend_times)]
                });
            }
        }

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', initializeCharts);

        // Handle form submission
        document.getElementById('optimization-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Show loading overlay
            document.getElementById('loading-overlay').style.display = 'flex';

            // Clear previous progress log
            document.getElementById('progress-log').innerHTML = '';

            const form = e.target;
            const formData = {
                n_cities: parseInt(form.n_cities.value),
                backend: form.backend.value,
                location: form.location.value,
                hybrid: form.hybrid.checked
            };

            try {
                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    updateDashboard(data);
                } else {
                    alert('Error: ' + data.error);
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            } catch (error) {
                alert('Error during optimization: ' + error.message);
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });

        // Listen for optimization progress updates
        socket.on('optimization_progress', (data) => {
            addProgressEntry(data.message, data.timestamp, data.error);
            if (data.data && data.data.status) {
                document.getElementById('optimization-status').textContent = data.data.status;
            }
        });
    </script>
</body>
</html>